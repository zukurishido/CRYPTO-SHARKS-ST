// Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…
let data = {
    '2024': {
        'Ð¯Ð½Ð²Ð°Ñ€ÑŒ': {
            'SPOT': { trades: [] },
            'FUTURES': { trades: [] },
            'DeFi': { trades: [] }
        }
    }
};

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸
function checkAuth() {
    return window.isAuthenticated || false;
}

// Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… - Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð²ÑÐµÐ¼ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð°
function loadData() {
    try {
        const savedData = localStorage.getItem('cryptoSharksData');
        if (savedData) {
            data = JSON.parse(savedData);
        }
    } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…:', error);
        showNotification('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…', 'error');
    }
}

// Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð°
function saveData() {
    if (!checkAuth()) {
        showNotification('Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½', 'error');
        return false;
    }

    try {
        localStorage.setItem('cryptoSharksData', JSON.stringify(data));
        return true;
    } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ:', error);
        showNotification('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ', 'error');
        return false;
    }
}

// ÐŸÐ°Ñ€ÑÐ¸Ð½Ð³ ÑÐ´ÐµÐ»Ð¾Ðº - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð°
function parseTrades(text) {
    if (!checkAuth()) {
        showNotification('Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½', 'error');
        return [];
    }

    const lines = text.split('\n').filter(line => line.trim());
    let currentCategory = '';
    let trades = [];
    
    lines.forEach(line => {
        const cleanLine = line.trim().replace(/["""'']/g, '');

        // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸
        if (cleanLine.match(/DEFI|Ð”Ð•Ð¤Ð˜|DEFI:|Ð”Ð•Ð¤Ð˜:|DEFIðŸš€/i)) {
            currentCategory = 'DeFi';
            return;
        } else if (cleanLine.match(/FUTURES|Ð¤Ð¬Ð®Ð§Ð•Ð Ð¡|FUTURES:|Ð¤Ð¬Ð®Ð§Ð•Ð Ð¡:|FUTURESðŸš€/i)) {
            currentCategory = 'FUTURES';
            return;
        } else if (cleanLine.match(/SPOT|Ð¡ÐŸÐžÐ¢|SPOT:|Ð¡ÐŸÐžÐ¢:|SPOTðŸš€/i)) {
            currentCategory = 'SPOT';
            return;
        }

        // Ð Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½Ñ‹ Ð´Ð»Ñ ÑÐ´ÐµÐ»Ð¾Ðº
        const patterns = [
            /[#]?(\w+)\s*([-+])\s*(\d+\.?\d*)%\s*(?:\((\d+)x\)?)?/i,
            /(\w+)\s*([-+])\s*(\d+\.?\d*)%\s*(?:\((\d+)x\)?)?/i,
            /(?:\d+[\.)]\s*)[#]?(\w+)\s*([-+])\s*(\d+\.?\d*)%\s*(?:\((\d+)x\)?)?/i,
            /(\w+)\s*[-\.]\s*([-+])\s*(\d+\.?\d*)%\s*(?:\((\d+)x\)?)?/i,
            /(\w+)([-+])(\d+\.?\d*)%\s*(?:\((\d+)x\)?)?/i,
            /(\w+)\s+(\d+\.?\d*)%/i  // ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ "Ð¿Ð°Ñ€Ð° Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚"
        ];

        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½
        for (const pattern of patterns) {
            const match = cleanLine.match(pattern);
            if (match && currentCategory) {
                const [_, symbol, sign, value, leverage] = match;
                const result = sign === '-' ? -parseFloat(value) : parseFloat(value);
                
                trades.push({
                    id: Date.now() + Math.random(),
                    pair: symbol.replace(/[^A-Za-z0-9]/g, ''),
                    result: result,
                    leverage: leverage || '',
                    status: result > 0 ? 'profit' : 'loss',
                    category: currentCategory,
                    timestamp: new Date().toISOString()
                });
                break;
            }
        }
    });

    return trades;
}

// Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ´ÐµÐ»Ð¾Ðº - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð°
function addTradeData(year, month, category, trades) {
    if (!checkAuth()) {
        showNotification('Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½', 'error');
        return false;
    }

    try {
        if (!data[year]) data[year] = {};
        if (!data[year][month]) data[year][month] = {};
        if (!data[year][month][category]) data[year][month][category] = { trades: [] };

        if (Array.isArray(trades)) {
            data[year][month][category].trades.push(...trades);
        } else {
            data[year][month][category].trades.push(trades);
        }
        
        return saveData();
    } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ:', error);
        showNotification('ÐžÑˆÐ¸Ð±ÐºÐ° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ´ÐµÐ»Ð¾Ðº', 'error');
        return false;
    }
}

// Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÐ´ÐµÐ»ÐºÐ¸ - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð°
function deleteTradeData(year, month, category, tradeId) {
    if (!checkAuth()) {
        showNotification('Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½', 'error');
        return false;
    }

    try {
        if (!data[year]?.[month]?.[category]) {
            console.error('ÐŸÑƒÑ‚ÑŒ Ðº Ð´Ð°Ð½Ð½Ñ‹Ð¼ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚');
            return false;
        }

        const trades = data[year][month][category].trades;
        const initialLength = trades.length;
        
        data[year][month][category].trades = trades.filter(trade => trade.id != tradeId);
        
        if (initialLength === data[year][month][category].trades.length) {
            console.error('Ð¡Ð´ÐµÐ»ÐºÐ° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°');
            return false;
        }

        return saveData();
    } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ:', error);
        showNotification('ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ ÑÐ´ÐµÐ»ÐºÐ¸', 'error');
        return false;
    }
}

// ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ´ÐµÐ»ÐºÐ¸ - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð°
function updateTradeData(year, month, category, tradeId, updatedData) {
    if (!checkAuth()) {
        showNotification('Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½', 'error');
        return false;
    }

    try {
        if (!data[year]?.[month]?.[category]) return false;

        const trades = data[year][month][category].trades;
        const index = trades.findIndex(t => t.id == tradeId);
        
        if (index !== -1) {
            trades[index] = { ...trades[index], ...updatedData };
            return saveData();
        }
        return false;
    } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ:', error);
        showNotification('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ´ÐµÐ»ÐºÐ¸', 'error');
        return false;
    }
}

// ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… - Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð²ÑÐµÐ¼ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð°
function getPeriodData(year, month, category) {
    try {
        return data[year]?.[month]?.[category]?.trades || [];
    } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…:', error);
        return [];
    }
}

// Ð Ð°ÑÑ‡ÐµÑ‚ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ - Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð²ÑÐµÐ¼ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð°
function calculateStats(trades) {
    try {
        let totalProfit = 0;
        let totalLoss = 0;
        let profitCount = 0;
        let lossCount = 0;
        
        trades.forEach(trade => {
            if (trade.result > 0) {
                totalProfit += trade.result;
                profitCount++;
            } else if (trade.result < 0) {
                totalLoss += Math.abs(trade.result);
                lossCount++;
            }
        });

        return {
            totalTrades: trades.length,
            profitTrades: profitCount,
            lossTrades: lossCount,
            totalProfit: totalProfit.toFixed(1),
            totalLoss: totalLoss.toFixed(1),
            winRate: trades.length > 0 ? ((profitCount / trades.length) * 100).toFixed(1) : 0
        };
    } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°ÑÑ‡ÐµÑ‚Ð° ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸:', error);
        return {
            totalTrades: 0,
            profitTrades: 0,
            lossTrades: 0,
            totalProfit: '0.0',
            totalLoss: '0.0',
            winRate: '0.0'
        };
    }
}

// ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð°
function clearPeriodData(year, month, category) {
    if (!checkAuth()) {
        showNotification('Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½', 'error');
        return false;
    }

    try {
        if (data[year]?.[month]?.[category]) {
            data[year][month][category].trades = [];
            return saveData();
        }
        return false;
    } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…:', error);
        return false;
    }
}

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ
document.addEventListener('DOMContentLoaded', () => {
    loadData();
    if (typeof updateContent === 'function') {
        updateContent();
    }
});
